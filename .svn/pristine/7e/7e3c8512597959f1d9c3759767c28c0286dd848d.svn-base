Ext.define('Isidamaps.services.brigadeForAssignView.BrigadeForAssignController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.brigadeforassign',
    BrigadeForAssign: null,
    urlGeodata: null,
    listen: {
        global: {
            jsonAnswerReady: 'buttonCheked',
            checkedBrigadeForAssign: 'checkedBrigadeForAssign'
        }
    },

    checkedBrigadeForAssign: function () {
        var me = this,
            store = me.getViewModel().getStore('Routes');
        store.each(function (rec) {
            rec.set('checkBox', false);
        })
    },

    mainBoxReady: function () {
        var me = this,
            property = me.getViewModel().getStore('Property');
        property.load(function (records) {
            records.forEach(function (data) {
                me.urlGeodata = data.get('urlGeodata');
            })
            ymaps.ready(function () {
                me.createMap();
            });
        });
    },

    createMap: function () {
        var me = this,
            bounds = [
                [60.007645, 30.092139],
                [59.923862, 30.519157]
            ];
        me.BrigadeForAssign = Ext.create('Isidamaps.services.brigadeForAssignView.MapService', {
            viewModel: me.getViewModel(),
            markerClick: me.markerClick,
            clustersClick: me.clustersClick,
            boundsMap: bounds,
            urlGeodata: me.urlGeodata,
            getStoreMarkerInfo: me.getStoreMarkerInfo
        });
        ASOV.setMapManager({
            setMarkers: me.BrigadeForAssign.setMarkers.bind(this)
        }, Ext.History.currentToken);
        var ymapWrapper = me.lookupReference('ymapWrapper');
        ymapWrapper.on('resize', function () {
            me.BrigadeForAssign.resizeMap();
        })
    },

    getStoreMarkerInfo: function (object) {
        var me = this,
            urlInfoMarker = Ext.String.format(me.urlGeodata + '/info?objectid={0}&objecttype={1}', object.id, object.customOptions.objectType);
        if (object.customOptions.objectType === 'BRIGADE') {
            return Ext.create('Ext.data.Store', {
                model: 'Isidamaps.model.InfoBrigade',
                proxy: {
                    type: 'ajax',
                    url: urlInfoMarker,
                    reader: {
                        type: 'json',
                        rootProperty: 'additionalInfo.brigade'
                    }
                },
                autoLoad: false
            });
        }
        if (object.customOptions.objectType === 'CALL') {
            return Ext.create('Ext.data.Store', {
                model: 'Isidamaps.model.InfoCall',
                proxy: {
                    type: 'ajax',
                    url: urlInfoMarker,
                    reader: {
                        type: 'json',
                        rootProperty: 'additionalInfo.call'
                    }
                },
                autoLoad: false
            });
        }
    },

    layoutReady: function () {
        this.fireTabEvent(this.lookupReference('navigationPanel'));
    },

    tabChange: function (panel, newTab, oldTab) {
        oldTab.fireEvent('tabExit');
        this.fireTabEvent(newTab);
    },

    fireTabEvent: function (tab) {
        tab.fireEvent('tabEnter');
    },

    clustersClick: function (coords, cluster) {
        var me = this,
            win = Ext.WindowManager.getActive(),
            ymapWrapper = Ext.getCmp('mapId'),
            sizeCmp = ymapWrapper.getSize();
        if (win) {
            win.close();
        }
        sizeCmp.width = sizeCmp.width * 1.25;
        if ((sizeCmp.width / 2) < coords[0]) {
            coords[0] -= 600;
            coords[1] += 20;
        }
        if ((sizeCmp.height / 2) < coords[1]) {
            coords[1] -= 300;
        }
        Ext.create('Ext.window.Window', {
            title: 'Кластер',
            layout: 'hbox',
            resizable: true,
            border: 'fit',
            width: 821,
            height: 405,
            scrollable: 'vertical',
            items: [{
                xtype: 'panel',
                id: 'markerInClustersId',
                autoScroll: true,
                layout: 'vbox',
                height: '100%',
                width: '20%'
            },
                {
                    xtype: 'panel',
                    id: 'infoMarkerId',
                    autoScroll: true,
                    height: '100%',
                    width: '80%'
                }
            ]
        }).showAt(coords);
        var markerInClusters = Ext.getCmp('markerInClustersId'),
            infoMarker = Ext.getCmp('infoMarkerId');
        markerInClusters.removeAll();
        cluster.features.forEach(function (marker) {
            if (marker.customOptions.objectType === 'CALL') {
                markerInClusters.add(Ext.create('Ext.Button', {
                    text: 'Вызов№ ' + marker.customOptions.callCardNum,
                    maxWidth: 150,
                    minWidth: 150,
                    margin: 5,
                    listeners: {
                        click: function () {
                            var storeMarker = me.getStoreMarkerInfo(marker);
                            infoMarker.removeAll();
                            storeMarker.load({
                                callback: function (records, operation, success) {
                                    if (success === true) {
                                        if (records.length === 0) {
                                            Ext.Msg.alert('Ошибка', 'Данные о вызове временно не доступны');
                                        }
                                    }
                                    if (success === false) {
                                        try {
                                            Ext.Msg.alert('Ошибка', 'Данные о вызове временно не доступны');
                                        } catch (e) {
                                            Ext.Msg.alert('Ошибка', 'Данные о вызове временно не доступны');
                                        }
                                    }
                                    if (success === true) {
                                        if (records.length > 0) {
                                            infoMarker.add(Ext.create('Ext.Panel', {
                                                layout: 'form',
                                                border: 'fit',
                                                autoScroll: true,
                                                resizable: false,
                                                width: '100%',
                                                items: [{
                                                    xtype: 'form',
                                                    height: '100%',
                                                    width: '100%',
                                                    margin: 0,
                                                    items: [{
                                                        xtype: 'displayfield',
                                                        name: 'callCardNum',
                                                        fieldLabel: 'Номер вызова',
                                                        labelWidth: '100%',
                                                        margin: 0
                                                    },
                                                        {
                                                            xtype: 'displayfield',
                                                            name: 'createTime',
                                                            fieldLabel: 'Время вызова',
                                                            labelWidth: '100%',
                                                            renderer: Ext.util.Format.dateRenderer('Y-m-d, h:i:s'),
                                                            margin: 0
                                                        },
                                                        {
                                                            xtype: 'textareafield',
                                                            name: 'reason',
                                                            labelWidth: 100,
                                                            width: 500,
                                                            readOnly: true,
                                                            fieldLabel: 'Повод к вызову',
                                                            margin: '0px 0px 5px 0px'
                                                        },
                                                        {
                                                            xtype: 'textareafield',
                                                            name: 'reasonComment',
                                                            labelWidth: 100,
                                                            width: 500,
                                                            readOnly: true,
                                                            fieldLabel: 'Комментарий',
                                                            margin: '5px 0px 0px 0px'
                                                        },
                                                        {
                                                            xtype: 'displayfield',
                                                            name: 'address',
                                                            labelWidth: '100%',
                                                            fieldLabel: 'Адрес места вызова',
                                                            margin: 0
                                                        },
                                                        {
                                                            xtype: 'displayfield',
                                                            name: 'enter',
                                                            labelWidth: '100%',
                                                            fieldLabel: 'Особенности входа',
                                                            margin: 0
                                                        },
                                                        {
                                                            xtype: 'displayfield',
                                                            name: 'phone',
                                                            labelWidth: '100%',
                                                            fieldLabel: 'Телефон',
                                                            margin: 0
                                                        },
                                                        {
                                                            xtype: 'displayfield',
                                                            name: 'fullName',
                                                            labelWidth: '100%',
                                                            fieldLabel: 'ФИО',
                                                            margin: 0
                                                        },
                                                        {
                                                            xtype: 'displayfield',
                                                            name: 'brigadeNum',
                                                            labelWidth: '100%',
                                                            fieldLabel: 'Номер бригады',
                                                            margin: 0
                                                        },
                                                        {
                                                            xtype: 'displayfield',
                                                            name: 'hospital',
                                                            labelWidth: '100%',
                                                            fieldLabel: 'Стационар',
                                                            margin: 0
                                                        }
                                                    ]
                                                }],
                                                listeners: {
                                                    afterrender: function (component) {
                                                        var form = component.down('form');
                                                        form.loadRecord(storeMarker.first());
                                                    }
                                                }
                                            }))
                                        }
                                    }
                                }
                            })
                        }
                    }
                }))
            }

            if (marker.customOptions.objectType === 'BRIGADE') {
                markerInClusters.add(Ext.create('Ext.Button', {
                    text: 'Бригада № ' + marker.customOptions.brigadeNum,
                    maxWidth: 150,
                    minWidth: 150,
                    margin: 5,
                    listeners: {
                        click: function () {
                            var storeMarker = me.getStoreMarkerInfo(marker);
                            infoMarker.removeAll();
                            storeMarker.load({
                                callback: function (records, operation, success) {
                                    if (success === true) {
                                        if (records.length === 0) {
                                            Ext.Msg.alert('Ошибка', 'Данные о бригаде временно не доступны');
                                        }
                                    }
                                    if (success === false) {
                                        try {
                                            Ext.Msg.alert('Ошибка', 'Данные о бригаде временно не доступны');
                                        } catch (e) {
                                            Ext.Msg.alert('Ошибка', 'Данные о бригаде временно не доступны');
                                        }
                                    }
                                    if (success === true) {
                                        if (records.length > 0) {
                                            var status = null;
                                            records.forEach(function (brigade) {
                                                switch (brigade.get('status')) {
                                                    case 'FREE':
                                                        status = 'Свободна';
                                                        break;
                                                    case 'ON_EVENT':
                                                        status = 'Дежурство на мероприятии';
                                                        break;
                                                    case 'WITHOUT_SHIFT':
                                                        status = 'Вне графика';
                                                        break;
                                                    case 'CRASH_CAR':
                                                        status = 'Ремонт';
                                                        break;
                                                    case 'PASSED_BRIGADE':
                                                        status = 'Принял вызов';
                                                        break;
                                                    case 'AT_CALL':
                                                        status = 'На вызове';
                                                        break;
                                                    case 'RELAXON':
                                                        status = 'Обед';
                                                        break;
                                                    case 'GO_HOSPITAL':
                                                        status = 'Транспортировка в стационар';
                                                        break;
                                                    case 'HIJACKING':
                                                        status = 'Нападение на бригаду';
                                                        break;
                                                    default:
                                                        status = 'Неизвестно';
                                                        break;
                                                }
                                            });
                                            infoMarker.add(Ext.create('Ext.Panel', {
                                                layout: 'form',
                                                border: 'fit',
                                                autoScroll: true,
                                                resizable: false,
                                                width: '100%',
                                                items: [{
                                                    xtype: 'form',
                                                    autoScroll: true,
                                                    height: '100%',
                                                    width: '100%',
                                                    items: [{
                                                        xtype: 'displayfield',
                                                        name: 'brigadeNum',
                                                        fieldLabel: 'Номер бригады',
                                                        labelWidth: '100%',
                                                        margin: 0
                                                    },
                                                        {
                                                            xtype: 'displayfield',
                                                            value: marker.customOptions.profile,
                                                            fieldLabel: 'Профиль бригады',
                                                            labelWidth: '100%',
                                                            margin: 0
                                                        },
                                                        {
                                                            xtype: 'displayfield',
                                                            value: status,
                                                            fieldLabel: 'Статус бригады',
                                                            labelWidth: '100%',
                                                            margin: 0
                                                        },
                                                        {
                                                            xtype: 'displayfield',
                                                            fieldLabel: 'Старший бригады',
                                                            name: 'chefName',
                                                            labelWidth: '100%',
                                                            margin: 0
                                                        },
                                                        {
                                                            xtype: 'displayfield',
                                                            name: 'callCardNum',
                                                            fieldLabel: 'Вызов',
                                                            labelWidth: '100%',
                                                            margin: 0
                                                        },
                                                        {
                                                            xtype: 'displayfield',
                                                            name: 'address',
                                                            fieldLabel: 'Адрес места вызова',
                                                            labelWidth: 150,
                                                            margin: 0
                                                        },
                                                        {
                                                            xtype: 'displayfield',
                                                            name: 'passToBrigadeTime',
                                                            fieldLabel: 'Время получения бригадой',
                                                            renderer: Ext.util.Format.dateRenderer('Y-m-d, h:i:s'),
                                                            labelWidth: '100%',
                                                            margin: 0
                                                        }
                                                    ]
                                                }],
                                                listeners: {
                                                    afterrender: function (component) {
                                                        var form = component.down('form');
                                                        form.loadRecord(storeMarker.first());
                                                    }
                                                }
                                            }))
                                        }
                                    }
                                }
                            })
                        }
                    }
                }))
            }
        })
    },

    markerClick: function (object, coords, infoMarker) {
        var win = Ext.WindowManager.getActive(),
            ymapWrapper = Ext.getCmp('mapId'),
            sizeCmp = ymapWrapper.getSize();
        if (win) {
            win.close();
        }
        sizeCmp.width = sizeCmp.width * 1.55;
        if (object.customOptions.objectType === 'BRIGADE') {
            if ((sizeCmp.width / 2) < coords[0]) {
                coords[0] -= 500;
                coords[1] += 20;
            }
            if ((sizeCmp.height / 2) < coords[1]) {
                coords[1] -= 270;
            }
            infoMarker.load({
                callback: function (records, operation, success) {
                    if (success === true) {
                        if (records.length === 0) {
                            Ext.Msg.alert('Ошибка', 'Данные о бригаде временно не доступны');
                        }
                    }
                    if (success === false) {
                        try {
                            Ext.Msg.alert('Ошибка', 'Данные о бригаде временно не доступны');
                        } catch (e) {
                            Ext.Msg.alert('Ошибка', 'Данные о бригаде временно не доступны');
                        }
                    }
                    if (success === true) {
                        if (records.length > 0) {
                            var status = null;
                            records.forEach(function (brigade) {
                                switch (brigade.get('status')) {
                                    case 'FREE':
                                        status = 'Свободна';
                                        break;
                                    case 'ON_EVENT':
                                        status = 'Дежурство на мероприятии';
                                        break;
                                    case 'WITHOUT_SHIFT':
                                        status = 'Вне графика';
                                        break;
                                    case 'CRASH_CAR':
                                        status = 'Ремонт';
                                        break;
                                    case 'PASSED_BRIGADE':
                                        status = 'Принял вызов';
                                        break;
                                    case 'AT_CALL':
                                        status = 'На вызове';
                                        break;
                                    case 'RELAXON':
                                        status = 'Обед';
                                        break;
                                    case 'GO_HOSPITAL':
                                        status = 'Транспортировка в стационар';
                                        break;
                                    case 'HIJACKING':
                                        status = 'Нападение на бригаду';
                                        break;
                                    default:
                                        status = 'Неизвестно';
                                        break;
                                }
                            });
                            Ext.create('Ext.window.Window', {
                                title: 'Бригада',
                                layout: 'form',
                                border: 'fit',
                                autoScroll: true,
                                resizable: false,
                                width: 450,
                                //height: 250,
                                items: [{
                                    xtype: 'form',
                                    autoScroll: true,
                                    height: '100%',
                                    width: '100%',
                                    items: [{
                                        xtype: 'displayfield',
                                        name: 'brigadeNum',
                                        fieldLabel: 'Номер бригады',
                                        labelWidth: '100%',
                                        margin: 0
                                    },
                                        {
                                            xtype: 'displayfield',
                                            value: object.customOptions.profile,
                                            fieldLabel: 'Профиль бригады',
                                            labelWidth: '100%',
                                            margin: 0
                                        },
                                        {
                                            xtype: 'displayfield',
                                            value: status,
                                            fieldLabel: 'Статус бригады',
                                            labelWidth: '100%',
                                            margin: 0
                                        },
                                        {
                                            xtype: 'displayfield',
                                            fieldLabel: 'Старший бригады',
                                            name: 'chefName',
                                            labelWidth: '100%',
                                            margin: 0
                                        },
                                        {
                                            xtype: 'displayfield',
                                            name: 'callCardNum',
                                            fieldLabel: 'Вызов',
                                            labelWidth: '100%',
                                            margin: 0
                                        },
                                        {
                                            xtype: 'displayfield',
                                            name: 'address',
                                            fieldLabel: 'Адрес места вызова',
                                            labelWidth: 150,
                                            margin: 0
                                        },
                                        {
                                            xtype: 'displayfield',
                                            name: 'passToBrigadeTime',
                                            fieldLabel: 'Время получения бригадой',
                                            renderer: Ext.util.Format.dateRenderer('Y-m-d, h:i:s'),
                                            labelWidth: '100%',
                                            margin: 0
                                        }
                                    ]
                                }],
                                listeners: {
                                    afterrender: function (component) {
                                        var form = component.down('form');
                                        form.loadRecord(infoMarker.first());
                                    }
                                }
                            }).showAt(coords);
                        }
                    }
                }
            })
        }
        if (object.customOptions.objectType === 'CALL') {
            if ((sizeCmp.width / 2) < coords[0]) {
                coords[0] -= 600;
                coords[1] += 20;
            }
            if ((sizeCmp.height / 2) < coords[1]) {
                coords[1] -= 450;
            }
            infoMarker.load({
                callback: function (records, operation, success) {
                    if (success === true) {
                        if (records.length === 0) {
                            Ext.Msg.alert('Ошибка', 'Данные о вызове временно не доступны');
                        }
                    }
                    if (success === false) {
                        try {
                            Ext.Msg.alert('Ошибка', 'Данные о вызове временно не доступны');
                        } catch (e) {
                            Ext.Msg.alert('Ошибка', 'Данные о вызове временно не доступны');
                        }
                    }
                    if (success === true) {
                        if (records.length > 0) {
                            Ext.create('Ext.window.Window', {
                                title: 'Вызов',
                                layout: 'form',
                                id: 'winId',
                                border: 'fit',
                                autoScroll: true,
                                resizable: false,
                                width: 550,
                                items: [{
                                    xtype: 'form',
                                    height: '100%',
                                    width: '100%',
                                    margin: 0,
                                    items: [{
                                        xtype: 'displayfield',
                                        name: 'callCardNum',
                                        fieldLabel: 'Номер вызова',
                                        labelWidth: '100%',
                                        margin: 0
                                    },
                                        {
                                            xtype: 'displayfield',
                                            name: 'createTime',
                                            fieldLabel: 'Время вызова',
                                            labelWidth: '100%',
                                            renderer: Ext.util.Format.dateRenderer('Y-m-d, h:i:s'),
                                            margin: 0
                                        },
                                        {
                                            xtype: 'textareafield',
                                            name: 'reason',
                                            labelWidth: 100,
                                            width: 500,
                                            readOnly: true,
                                            fieldLabel: 'Повод к вызову',
                                            margin: '0px 0px 5px 0px'
                                        },
                                        {
                                            xtype: 'textareafield',
                                            name: 'reasonComment',
                                            labelWidth: 100,
                                            width: 500,
                                            readOnly: true,
                                            fieldLabel: 'Комментарий',
                                            margin: '5px 0px 0px 0px'
                                        },
                                        {
                                            xtype: 'displayfield',
                                            name: 'address',
                                            labelWidth: '100%',
                                            fieldLabel: 'Адрес места вызова',
                                            margin: 0
                                        },
                                        {
                                            xtype: 'displayfield',
                                            name: 'enter',
                                            labelWidth: '100%',
                                            fieldLabel: 'Особенности входа',
                                            margin: 0
                                        },
                                        {
                                            xtype: 'displayfield',
                                            name: 'phone',
                                            labelWidth: '100%',
                                            fieldLabel: 'Телефон',
                                            margin: 0
                                        },
                                        {
                                            xtype: 'displayfield',
                                            name: 'fullName',
                                            labelWidth: '100%',
                                            fieldLabel: 'ФИО',
                                            margin: 0
                                        },
                                        {
                                            xtype: 'displayfield',
                                            name: 'brigadeNum',
                                            labelWidth: '100%',
                                            fieldLabel: 'Номер бригады',
                                            margin: 0
                                        },
                                        {
                                            xtype: 'displayfield',
                                            name: 'hospital',
                                            labelWidth: '100%',
                                            fieldLabel: 'Стационар',
                                            margin: 0
                                        }
                                    ]
                                }],
                                listeners: {
                                    afterrender: function (component) {
                                        var form = component.down('form');
                                        form.loadRecord(infoMarker.first());
                                    }
                                }
                            }).showAt(coords);
                        }
                    }
                }
            })
        }
    },

    buttonCheked: function () {
        this.BrigadeForAssign.createAnswer();
    }
});
